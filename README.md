#Device Tracking

##Demo

A live demo is at [https://www.stephenbooher.com/device-tracking/index.html](https://www.stephenbooher.com/device-tracking/index.html).

The demo supports Firefox, Chrome, Internet Explorer, Edge, Chrome for Android, and Firefox for Android. I did not have access to a recent iOS device to test.

In my testing, the demo passes challenge **G** in the browsers listed above.

##How It Works

###Short Version

It uses cookies and WebRTC IPs for most of the work, and attempts to fill in the gaps with screen resolution, OS information, and various browser storage and caching mechanisms. It uses front-end JavaScript and Node.js.

###Long Version

The website initially uses cookies, local storage, session storage, IndexedDB, Silverlight Isolated Storage, and Flash Local Shared Objects (LSOs) to store a tracking ID. The cookies are the basic way to keep track of the device, but the other methods help keep the tracking ID around if the cookies, caches, or other data are deleted. On every page load, the page reads from all the places the tracking ID might be stored until it finds it. The browser then makes a GET request to the Node.js server to record some information and request a potentially new tracking ID if it was unable to find one.

The request contains WebRTC IPs, both private and public, as well as the screen resolution and OS information. I believe using the IPs is a reasonable way to uniquely identify a device. The screen resolution and OS information are used to attempt to distinguish two devices if WebRTC is not available or disabled. Optionally, the request may also contain a `trackingID`, if known. (Most of the time, the `trackingID` will be known, unless it is the browser's first visit to the page.) If `trackingID` is not included, the web server will look in redis to see if the key maps to an existing tracking ID. If the tracking ID is included, then the server will update the entry.

If necessary, a unique tracking ID is generated by Node.js and passed to the browser. There is an opportunity for the service worker cache to cache this value for next time. HTTPS is necessary for service workers to work. HTML 5 appcache is used as a fallback.

Silverlight Isolated Storage and Adobe Flash LSOs are useful to propagate a device ID between two browsers on the same device.

##Remarks

* The client-side code is fairly messy at the moment.
* Local storage, session storage, and the file system API seem to offer limited advantages over a cookie (unless maybe they would work better from third party domains?).
* HTML 5 application cache and service workers were huge time sinks with little reward so far. The main benefit I see in caching mechanisms is that they are likely to always be enabled, and are not seen as intrusive.
* Flash LSOs seem to only work cross-browser when the actual Adobe Flash plugin is installed (i.e., Chrome and MS Edge are not cross-browser).
* I considered iterating through the fonts via Flash and using the list of Fonts as a data point, but decided against it due to the general lack of Flash on mobile.

###Potential Flaws with Approach

* Some browsers prompt to enable plugins like Silverlight and Flash which make those methods less appealing for sites which do not have an existing reason to use these plugins. Plus, they are relatively slow. And they don't work on most mobile browsers.
* Browsers which do not support or disable WebRTC are more likely to be incorrectly reported as different devices.
* If the user clears their caches successfully, then joins a different network (e.g., user switches from local WiFi to data plan), then the user will be seen as a new device.

###Future Work or Possible Improvements

* It may be possible use some of the navigator properties or HTML 5 feature detection to identify devices. E.g., if a device has an accelerometer and a battery, it might be different from another device that just has a battery. 
* The OS detection from the user-agent can be improved to add more versions (like Android version).
* Lint code with eslint and document with jsdoc comments.
* Fix current delays when using Flash and Silverlight.
* Instead of requesting a unique ID from the server, the device key could be reused as a tracking ID.

###Other Notes

I wrote my own web analytics service for fun in college around 2008, and have thus previously thought about and experimented with several techniques like this.
